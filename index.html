<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>GoldX Market</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <style>
    body { margin:0; padding:15px; background:#0a0a14; color:#e0e0ff; font-family:Arial; text-align:center; }
    #avatar { width:92px; height:92px; border-radius:50%; border:4px solid #00d4ff; margin:20px auto 15px; }
    .balances { display:flex; justify-content:center; gap:10px; margin:15px 0 25px; }
    .balance-item { background:#1a1a2e; padding:11px 18px; border-radius:16px; flex:1; max-width:110px; }
    button { width:88%; max-width:280px; padding:14px; margin:8px auto; display:block; background:#0066ff; color:white; border:none; border-radius:14px; font-size:1.02em; font-weight:600; }
    #connect-btn { background:linear-gradient(90deg,#00d4ff,#3388ff); color:#000; font-weight:bold; }
    #toast { position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:#1a1a2e; color:#00d4ff; padding:12px 24px; border-radius:999px; display:none; z-index:100; }
  </style>
</head>
<body>
  <img id="avatar" src="" alt="Avatar">

  <div class="balances">
    <div class="balance-item">GoldX: <span id="gold">0</span></div>
    <div class="balance-item">TON: <span id="ton">0</span></div>
    <div class="balance-item">Staked: <span id="staked">0</span></div>
  </div>

  <button id="connect-btn">Подключить TON кошелёк</button>
  <button id="stake-btn">Стейк TON (мин 1000)</button>
  <button id="claim-btn">Claim Rewards</button>
  <button id="buy-key-btn">Купить ключ (0.1 TON)</button>
  <button id="open-case-btn">Открыть кейс (10 GoldX)</button>

  <div id="ton-connect" style="display:none;"></div>
  <div id="toast"></div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const user = tg.initDataUnsafe?.user;
    if (user) document.getElementById('avatar').src = user.photo_url || 'https://via.placeholder.com/92';

    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: 'https://gold-x-flax.vercel.app/tonconnect-manifest.json',
      buttonRootId: 'ton-connect',
      actionsConfiguration: {
        twaReturnUrl: 'https://t.me/GoldXMarket_bot'   // Твой бот
      },
      uiPreferences: { theme: 'DARK' }
    });

    let walletAddress = null;

    tonConnectUI.onStatusChange(wallet => {
      if (wallet?.account?.address) {
        walletAddress = wallet.account.address;
        document.getElementById('connect-btn').style.display = 'none';
        loadBalance();
        showToast('Кошелёк подключён!');
      }
    });

    const API = '/api';

    async function loadBalance() {
      if (!walletAddress) return;
      try {
        const res = await fetch(`\( {API}/balance/ \){walletAddress}`);
        const data = await res.json();
        document.getElementById('gold').textContent = data.goldX || 0;
        document.getElementById('ton').textContent = data.ton || 0;
        document.getElementById('staked').textContent = data.stakedTON || 0;
      } catch(e) {}
    }

    document.getElementById('connect-btn').onclick = () => tonConnectUI.openModal();

    document.getElementById('stake-btn').onclick = async () => {
      if (!walletAddress) return showToast('Подключи кошелёк');
      const amount = prompt('Сколько TON стейкать? (мин 1000)', '1000');
      if (!amount || amount < 1000) return;
      try {
        await tonConnectUI.sendTransaction({
          messages: [{ address: 'UQBkqGcHhyjf4sRcuaeSpoWH8OKPZueOOStkd2I96c2aIF8G', amount: (parseFloat(amount)*1e9).toString() }]
        });
        showToast('TON отправлен!');
        setTimeout(loadBalance, 10000);
      } catch(e) { showToast('Ошибка: ' + e.message); }
    };

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.display = 'block';
      setTimeout(() => t.style.display = 'none', 3000);
    }
  </script>
</body>
</html>
